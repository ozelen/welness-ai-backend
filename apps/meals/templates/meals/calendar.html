{% extends "base.html" %}
{% load meal_extras %}

{% block title %}Meal Calendar{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Meal Calendar</h1>
                <p class="text-gray-600">Weekly view of your scheduled and completed meals</p>
            </div>
            <div class="flex space-x-3">
                <a href="{% url 'meals:meals' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                    Manage Meals
                </a>
                <a href="{% url 'meals:dashboard' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Week Navigation -->
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-4">
            <div class="flex items-center justify-between">
                <a href="?week={{ prev_week_param }}" 
                   class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                    </svg>
                    Previous Week
                </a>
                
                <div class="text-center">
                    <h2 class="text-xl font-semibold text-gray-900">
                        {{ week_start|date:"M j" }} - {{ week_end|date:"M j, Y" }}
                    </h2>
                    <p class="text-sm text-gray-600">
                        Week {{ current_week_param|slice:"5:" }} of {{ current_week_param|slice:":4" }}
                    </p>
                </div>
                
                <a href="?week={{ next_week_param }}" 
                   class="inline-flex items-center px-3 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Next Week
                    <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                    </svg>
                </a>
            </div>
        </div>
    </div>

    <!-- Weekly Nutrition Summary -->
    {% if weekly_targets %}
    <div class="bg-white rounded-lg shadow mb-6">
        <div class="p-6">
            <h3 class="text-lg font-medium text-gray-900 mb-4">Weekly Nutrition Summary</h3>
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600">{{ week_totals.calories|floatformat:0 }}</div>
                    <div class="text-sm text-gray-600">Calories</div>
                                        <div class="text-xs text-gray-500">
                        Target: {{ weekly_targets.calories|floatformat:0 }}
                        {% if week_percentages %}
                        ({{ week_percentages.calories|floatformat:0 }}%)
                        {% endif %}
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600">{{ week_totals.proteins|floatformat:1 }}g</div>
                    <div class="text-sm text-gray-600">Protein</div>
                    <div class="text-xs text-gray-500">
                        Target: {{ weekly_targets.proteins|floatformat:1 }}g
                        {% if week_percentages %}
                        ({{ week_percentages.proteins|floatformat:0 }}%)
                        {% endif %}
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-yellow-600">{{ week_totals.carbs|floatformat:1 }}g</div>
                    <div class="text-sm text-gray-600">Carbs</div>
                    <div class="text-xs text-gray-500">
                        Target: {{ weekly_targets.carbs|floatformat:1 }}g
                        {% if week_percentages %}
                        ({{ week_percentages.carbs|floatformat:0 }}%)
                        {% endif %}
                    </div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-600">{{ week_totals.fats|floatformat:1 }}g</div>
                    <div class="text-sm text-gray-600">Fat</div>
                    <div class="text-xs text-gray-500">
                        Target: {{ weekly_targets.fats|floatformat:1 }}g
                        {% if week_percentages %}
                        ({{ week_percentages.fats|floatformat:0 }}%)
                        {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Calendar Grid -->
    <div class="bg-white rounded-lg shadow overflow-hidden">
        <!-- Calendar Header -->
        <div class="grid grid-cols-7 bg-gray-50 border-b">
            <div class="p-4 text-center font-medium text-gray-900">Monday</div>
            <div class="p-4 text-center font-medium text-gray-900">Tuesday</div>
            <div class="p-4 text-center font-medium text-gray-900">Wednesday</div>
            <div class="p-4 text-center font-medium text-gray-900">Thursday</div>
            <div class="p-4 text-center font-medium text-gray-900">Friday</div>
            <div class="p-4 text-center font-medium text-gray-900">Saturday</div>
            <div class="p-4 text-center font-medium text-gray-900">Sunday</div>
        </div>

        <!-- Calendar Days -->
        <div class="grid grid-cols-7">
            {% for day in week_days %}
            <div class="min-h-48 border-r border-gray-200 {% if forloop.last %}border-r-0{% endif %}">
                <!-- Date Header -->
                <div class="p-3 border-b border-gray-200 {% if day == week_start %}bg-blue-50{% endif %}">
                    <div class="text-sm font-medium text-gray-900">{{ day|date:"M j" }}</div>
                    <div class="text-xs text-gray-500">{{ day|date:"D" }}</div>
                </div>

                <!-- Day Content -->
                <div class="p-3 space-y-2">

                    
                    <!-- Meals -->
                    {% with day_data=meals_by_day|get_item:day %}
                    {% with completed_meals=completed_meal_ids_by_day|get_item:day %}
                    
                    <!-- Scheduled Meals -->
                    {% for meal in day_data.scheduled %}
                    {% with is_completed=meal.id|in_set:completed_meals %}
                    <div class="meal-card {% if is_completed %}bg-green-50 border-green-200{% else %}bg-blue-50 border-blue-200{% endif %} border rounded p-2" 
                         data-meal-id="{{ meal.id }}" 
                         data-date="{{ day|date:'Y-m-d' }}">
                        
                        
                        <!-- Content Row -->
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium {% if is_completed %}text-green-900{% else %}text-blue-900{% endif %} truncate">{{ meal.name }}</div>
                            {% if meal.start_time %}
                            <div class="text-xs font-semibold {% if is_completed %}text-green-700{% else %}text-blue-700{% endif %}">{{ meal.start_time|time:"g:i A" }}</div>
                            {% endif %}
                            <div class="text-xs {% if is_completed %}text-green-600{% else %}text-blue-600{% endif %}">
                                {{ meal.meal_type|title }}
                                {% if meal.recurrence_type != 'none' %}
                                <span class="{% if is_completed %}text-green-500{% else %}text-blue-500{% endif %}">• {{ meal.recurrence_type|format_recurrence }}</span>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Icons Row -->
                        <div class="flex justify-end items-center space-x-1 mb-2">
                                                            <!-- Feedback Button - Show for completed meals -->
                                {% if is_completed %}
                                <button onclick="openFeedbackModal({{ meal.id }}, '{{ day|date:'Y-m-d' }}')" 
                                        class="feedback-btn p-1 rounded-full transition-colors duration-200 hover:bg-blue-100"
                                        title="Add feedback"
                                        data-meal-id="{{ meal.id }}"
                                        data-date="{{ day|date:'Y-m-d' }}">
                                    <span class="material-icons text-blue-600 text-lg feedback-icon" 
                                          data-meal-id="{{ meal.id }}" 
                                          data-date="{{ day|date:'Y-m-d' }}">rate_review</span>
                                </button>
                                {% endif %}
                            
                            <!-- Completion Status - Only show for current day -->
                            {% if day == current_date %}
                            <button onclick="toggleMealCompletion({{ meal.id }}, '{{ day|date:'Y-m-d' }}')" 
                                    class="meal-completion-btn p-1 rounded-full transition-colors duration-200 {% if is_completed %}bg-green-200 hover:bg-green-300{% endif %}"
                                    data-meal-id="{{ meal.id }}"
                                    data-date="{{ day|date:'Y-m-d' }}"
                                    title="{% if is_completed %}Unmark as completed{% else %}Mark as completed{% endif %}">
                                {% if is_completed %}
                                <span class="material-icons text-green-600 text-lg">check_circle</span>
                                {% else %}
                                <span class="material-icons text-gray-400 text-lg">radio_button_unchecked</span>
                                {% endif %}
                            </button>
                            {% else %}
                            <!-- Show completion status for non-current days (read-only) -->
                            {% if is_completed %}
                            <div class="p-1 rounded-full bg-green-200">
                                <span class="material-icons text-green-600 text-lg">check_circle</span>
                            </div>
                            {% else %}
                            <div class="p-1 rounded-full bg-gray-100">
                                <span class="material-icons text-gray-400 text-lg">radio_button_unchecked</span>
                            </div>
                            {% endif %}
                            {% endif %}
                        </div>
                    </div>
                    {% endwith %}
                    {% endfor %}
                    
                    <!-- Unplanned Meal Records -->
                    {% for record in meal_records %}
                    {% if record.timestamp.date == day and not record.meal %}
                    <div class="meal-card bg-orange-50 border-orange-200 border rounded p-2" 
                         data-record-id="{{ record.id }}">
                        <!-- Icons Row -->
                        <div class="flex justify-end items-center space-x-1 mb-2">
                            <!-- Edit Button -->
                            <button onclick="openEditMealRecordModal({{ record.id }})" 
                                    class="edit-btn p-1 rounded-full transition-colors duration-200 hover:bg-orange-100"
                                    title="Edit meal">
                                <span class="material-icons text-orange-600 text-lg">edit</span>
                            </button>
                            
                            <!-- Delete Button -->
                            <button onclick="deleteMealRecord({{ record.id }})" 
                                    class="delete-btn p-1 rounded-full transition-colors duration-200 hover:bg-red-100"
                                    title="Delete meal">
                                <span class="material-icons text-red-600 text-lg">delete</span>
                            </button>
                            
                            <!-- Feedback Button -->
                            <button onclick="openFeedbackModal(null, '{{ day|date:'Y-m-d' }}', {{ record.id }})" 
                                    class="feedback-btn p-1 rounded-full transition-colors duration-200 hover:bg-blue-100"
                                    title="Add feedback"
                                    data-record-id="{{ record.id }}"
                                    data-date="{{ day|date:'Y-m-d' }}">
                                <span class="material-icons text-blue-600 text-lg feedback-icon" 
                                      data-record-id="{{ record.id }}" 
                                      data-date="{{ day|date:'Y-m-d' }}">rate_review</span>
                            </button>
                        </div>
                        
                        <!-- Content Row -->
                        <div class="flex-1 min-w-0">
                            <div class="text-sm font-medium text-orange-900 truncate">{{ record.meal_name }}</div>
                            <div class="text-xs font-semibold text-orange-700">{{ record.timestamp|time:"g:i A" }}</div>
                            <div class="text-xs text-orange-600">
                                Unplanned
                                {% if record.quantity_grams %}
                                <span class="text-orange-500">• {{ record.quantity_grams|floatformat:0 }}g</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                    
                    {% endwith %}
                    {% endwith %}
                </div>
            </div>
            {% endfor %}
        </div>

        <!-- Daily Totals Row -->
        <div class="grid grid-cols-7 bg-gray-50 border-t border-gray-200">
            {% for day in week_days %}
            <div class="p-3 border-r border-gray-200 {% if forloop.last %}border-r-0{% endif %}">
                {% with day_data=meals_by_day|get_item:day %}
                {% if day_data.planned_calories > 0 or day_data.taken_calories > 0 %}
                <div class="text-left space-y-1">
                    <!-- Calories -->
                    <div class="text-sm font-bold text-gray-900 text-center">
                        {{ day_data.taken_calories|floatformat:0 }} kcal
                    </div>
                    
                    <!-- Protein -->
                    {% if day_data.planned_proteins > 0 %}
                    <div class="flex items-center space-x-1">
                        {% if day_data.taken_proteins|get_overtaken_icon:day_data.planned_proteins %}
                        <span class="material-icons text-sm text-orange-600" style="line-height: 1;">warning</span>
                        {% else %}
                        <span class="material-icons text-sm {{ day_data.taken_proteins|get_battery_color:day_data.planned_proteins }}" style="line-height: 1;">
                            {% if day_data.taken_proteins|get_battery_icon:day_data.planned_proteins == 'full' %}
                            check_circle
                            {% elif day_data.taken_proteins|get_battery_icon:day_data.planned_proteins == 'half' %}
                            battery_6_bar
                            {% else %}
                            battery_0_bar
                            {% endif %}
                        </span>
                        {% endif %}
                        <span class="text-xs text-gray-700">prot: {{ day_data.taken_proteins|div:day_data.planned_proteins|mul:100|floatformat:0 }}%</span>
                    </div>
                    {% endif %}
                    
                    <!-- Carbs -->
                    {% if day_data.planned_carbs > 0 %}
                    <div class="flex items-center space-x-1">
                        {% if day_data.taken_carbs|get_overtaken_icon:day_data.planned_carbs %}
                        <span class="material-icons text-sm text-orange-600" style="line-height: 1;">warning</span>
                        {% else %}
                        <span class="material-icons text-sm {{ day_data.taken_carbs|get_battery_color:day_data.planned_carbs }}" style="line-height: 1;">
                            {% if day_data.taken_carbs|get_battery_icon:day_data.planned_carbs == 'full' %}
                            check_circle
                            {% elif day_data.taken_carbs|get_battery_icon:day_data.planned_carbs == 'half' %}
                            battery_6_bar
                            {% else %}
                            battery_0_bar
                            {% endif %}
                        </span>
                        {% endif %}
                        <span class="text-xs text-gray-700">carb: {{ day_data.taken_carbs|div:day_data.planned_carbs|mul:100|floatformat:0 }}%</span>
                    </div>
                    {% endif %}
                    
                    <!-- Fats -->
                    {% if day_data.planned_fats > 0 %}
                    <div class="flex items-center space-x-1">
                        {% if day_data.taken_fats|get_overtaken_icon:day_data.planned_fats %}
                        <span class="material-icons text-sm text-orange-600" style="line-height: 1;">warning</span>
                        {% else %}
                        <span class="material-icons text-sm {{ day_data.taken_fats|get_battery_color:day_data.planned_fats }}" style="line-height: 1;">
                            {% if day_data.taken_fats|get_battery_icon:day_data.planned_fats == 'full' %}
                            check_circle
                            {% elif day_data.taken_fats|get_battery_icon:day_data.planned_fats == 'half' %}
                            battery_6_bar
                            {% else %}
                            battery_0_bar
                            {% endif %}
                        </span>
                        {% endif %}
                        <span class="text-xs text-gray-700">fat: {{ day_data.taken_fats|div:day_data.planned_fats|mul:100|floatformat:0 }}%</span>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="text-center text-gray-400">
                    <div class="text-sm">No meals</div>
                    <div class="text-xs">planned</div>
                </div>
                {% endif %}
                {% endwith %}
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Log Meal Button (Only for Today) -->
    {% if current_date in week_days %}
    <div class="mt-6 flex justify-center">
        <button onclick="openLogMealModal('{{ current_date|date:'Y-m-d' }}')" 
                class="px-6 py-3 border-2 border-dashed border-orange-300 rounded-lg text-orange-600 hover:border-orange-400 hover:text-orange-700 transition-colors duration-200 flex items-center">
            <span class="material-icons text-lg mr-2">restaurant</span>
            <span class="text-lg font-medium">Log Today's Meal</span>
        </button>
    </div>
    {% endif %}


    <!-- Legend -->
    <div class="mt-6 bg-white rounded-lg shadow p-4">
        <h3 class="text-sm font-medium text-gray-900 mb-3">Legend</h3>
        <div class="flex flex-wrap gap-4 text-sm">
            <div class="flex items-center">
                <div class="w-4 h-4 bg-blue-50 border border-blue-200 rounded mr-2"></div>
                <span class="text-gray-700">Scheduled Meal</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 bg-green-50 border border-green-200 rounded mr-2"></div>
                <span class="text-gray-700">Completed Meal</span>
            </div>
            <div class="flex items-center">
                <div class="w-4 h-4 bg-blue-50 border border-blue-200 rounded mr-2"></div>
                <span class="text-gray-700">Today</span>
            </div>
        </div>
    </div>

    <!-- Weekly Totals -->
    <div class="bg-white rounded-lg shadow overflow-hidden mt-4">
        <div class="p-4 border-b border-gray-200">
            <h3 class="text-lg font-medium text-gray-900">Weekly Summary</h3>
        </div>
        <div class="p-4">
            <div class="grid grid-cols-4 gap-4">
                <div class="text-center">
                    <div class="text-2xl font-bold text-blue-600">{{ week_totals.taken_calories|floatformat:0 }}/{{ week_totals.planned_calories|floatformat:0 }}</div>
                    <div class="text-sm text-gray-600">Calories (Taken/Planned)</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-green-600">{{ week_totals.taken_proteins|floatformat:1 }}/{{ week_totals.planned_proteins|floatformat:1 }}</div>
                    <div class="text-sm text-gray-600">Protein (g) (Taken/Planned)</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-yellow-600">{{ week_totals.taken_carbs|floatformat:1 }}/{{ week_totals.planned_carbs|floatformat:1 }}</div>
                    <div class="text-sm text-gray-600">Carbs (g) (Taken/Planned)</div>
                </div>
                <div class="text-center">
                    <div class="text-2xl font-bold text-red-600">{{ week_totals.taken_fats|floatformat:1 }}/{{ week_totals.planned_fats|floatformat:1 }}</div>
                    <div class="text-sm text-gray-600">Fats (g) (Taken/Planned)</div>
                </div>
            </div>
            {% if active_diet %}
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="grid grid-cols-4 gap-4">
                    <div class="text-center">
                        <div class="text-lg font-medium text-gray-900">{{ week_percentages.calories|floatformat:1 }}%</div>
                        <div class="text-xs text-gray-600">of weekly target</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-medium text-gray-900">{{ week_percentages.proteins|floatformat:1 }}%</div>
                        <div class="text-xs text-gray-600">of weekly target</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-medium text-gray-900">{{ week_percentages.carbs|floatformat:1 }}%</div>
                        <div class="text-xs text-gray-600">of weekly target</div>
                    </div>
                    <div class="text-center">
                        <div class="text-lg font-medium text-gray-900">{{ week_percentages.fats|floatformat:1 }}%</div>
                        <div class="text-xs text-gray-600">of weekly target</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Log Meal Modal (Record Only) -->
<div id="logMealModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">Log Meal</h3>
                    <button onclick="closeLogMealModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            </div>
            <form id="logMealForm" class="p-6">
                <div class="space-y-4">
                    <div>
                        <label for="log_meal_name" class="block text-sm font-medium text-gray-700">Meal Name *</label>
                        <input type="text" id="log_meal_name" name="name" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                               placeholder="What did you eat?">
                    </div>
                    
                    <div>
                        <label for="log_date" class="block text-sm font-medium text-gray-700">Date *</label>
                        <input type="date" id="log_date" name="date" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="log_time" class="block text-sm font-medium text-gray-700">Time *</label>
                        <input type="time" id="log_time" name="time" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <!-- Nutritional Information -->
                    <div class="border-t pt-4">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Nutritional Information</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="log_quantity" class="block text-xs font-medium text-gray-700">Quantity (g)</label>
                                <input type="number" id="log_quantity" name="quantity_grams" step="0.1" min="0"
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div>
                                <label for="log_calories" class="block text-xs font-medium text-gray-700">Calories</label>
                                <input type="number" id="log_calories" name="calories" step="0.1" min="0"
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div>
                                <label for="log_proteins" class="block text-xs font-medium text-gray-700">Proteins (g)</label>
                                <input type="number" id="log_proteins" name="proteins" step="0.1" min="0"
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div>
                                <label for="log_carbs" class="block text-xs font-medium text-gray-700">Carbs (g)</label>
                                <input type="number" id="log_carbs" name="carbs" step="0.1" min="0"
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div class="col-span-2">
                                <label for="log_fats" class="block text-xs font-medium text-gray-700">Fats (g)</label>
                                <input type="number" id="log_fats" name="fats" step="0.1" min="0"
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeLogMealModal()" 
                            class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-orange-600 hover:bg-orange-700">
                        Log Meal
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Schedule Meal Modal -->
<div id="scheduleMealModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">Add Meal to Calendar</h3>
                    <button onclick="closeScheduleMealModal()" class="text-gray-400 hover:text-gray-600">
                        <span class="material-icons">close</span>
                    </button>
                </div>
            </div>
            <form id="scheduleMealForm" class="p-6">
                <input type="hidden" id="schedule_meal_id" name="meal_id">
                <div class="space-y-4">
                    <div>
                        <label for="schedule_meal_name" class="block text-sm font-medium text-gray-700">Meal Name *</label>
                        <input type="text" id="schedule_meal_name" name="name" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Enter meal name">
                    </div>
                    
                    <div>
                        <label for="schedule_date" class="block text-sm font-medium text-gray-700">Date *</label>
                        <input type="date" id="schedule_date" name="start_date" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div id="end_date_div" class="hidden">
                        <label for="schedule_end_date" class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" id="schedule_end_date" name="end_date"
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Leave empty for no end date</p>
                    </div>
                    
                    <div>
                        <label for="schedule_time" class="block text-sm font-medium text-gray-700">Time *</label>
                        <input type="time" id="schedule_time" name="start_time" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="schedule_duration" class="block text-sm font-medium text-gray-700">Duration (minutes)</label>
                        <input type="number" id="schedule_duration" name="duration_minutes" value="30" min="15" max="180" step="15"
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="schedule_meal_type" class="block text-sm font-medium text-gray-700">Meal Type</label>
                        <select id="schedule_meal_type" name="meal_type"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="regular">Regular Meal</option>
                            <option value="cheat">Cheat Meal</option>
                            <option value="refeed">Refeed Meal</option>
                            <option value="pre_workout">Pre-Workout</option>
                            <option value="post_workout">Post-Workout</option>
                            <option value="snack">Snack</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="schedule_recurrence" class="block text-sm font-medium text-gray-700">Recurrence</label>
                        <select id="schedule_recurrence" name="recurrence_type"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="none">No Recurrence</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="weekday">Weekdays (Mon-Fri)</option>
                            <option value="weekend">Weekends (Sat-Sun)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    
                    <div id="recurrence_until_div" class="hidden">
                        <label for="schedule_recurrence_until" class="block text-sm font-medium text-gray-700">Until Date</label>
                        <input type="date" id="schedule_recurrence_until" name="recurrence_until"
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <!-- Nutritional Information (for unplanned meals) -->
                    <div class="border-t pt-4">
                        <h4 class="text-sm font-medium text-gray-900 mb-3">Nutritional Information (Optional)</h4>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label for="schedule_quantity" class="block text-xs font-medium text-gray-700">Quantity (g)</label>
                                <input type="number" id="schedule_quantity" name="quantity_grams" step="0.1" min="0"
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div>
                                <label for="schedule_calories" class="block text-xs font-medium text-gray-700">Calories</label>
                                <input type="number" id="schedule_calories" name="calories" step="0.1" min="0"
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div>
                                <label for="schedule_proteins" class="block text-xs font-medium text-gray-700">Proteins (g)</label>
                                <input type="number" id="schedule_proteins" name="proteins" step="0.1" min="0"
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div>
                                <label for="schedule_carbs" class="block text-xs font-medium text-gray-700">Carbs (g)</label>
                                <input type="number" id="schedule_carbs" name="carbs" step="0.1" min="0"
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                            <div class="col-span-2">
                                <label for="schedule_fats" class="block text-xs font-medium text-gray-700">Fats (g)</label>
                                <input type="number" id="schedule_fats" name="fats" step="0.1" min="0"
                                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-between">
                    <button type="button" onclick="removeSchedule()" 
                            class="px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50"
                            id="removeScheduleBtn" style="display: none;">
                        Remove Schedule
                    </button>
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeScheduleMealModal()" 
                                class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                            <span id="scheduleSubmitText">Add Meal</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Feedback Modal -->
<div id="feedbackModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-medium text-gray-900">Meal Feedback</h3>
                <button onclick="closeFeedbackModal()" class="text-gray-400 hover:text-gray-600">
                    <span class="material-icons">close</span>
                </button>
            </div>
            
            <form id="feedbackForm" enctype="multipart/form-data">
                <input type="hidden" id="feedbackMealId" name="meal_id">
                <input type="hidden" id="feedbackDate" name="date">
                
                <div class="mb-4">
                    <label for="feedbackText" class="block text-sm font-medium text-gray-700 mb-2">Feedback</label>
                    <textarea id="feedbackText" name="feedback" rows="4" 
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                              placeholder="How was this meal? Any notes or observations..."></textarea>
                </div>
                
                <div class="mb-4">
                    <label for="feedbackPhoto" class="block text-sm font-medium text-gray-700 mb-2">Photo (optional)</label>
                    <input type="file" id="feedbackPhoto" name="photo" accept="image/*"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeFeedbackModal()" 
                            class="px-4 py-2 text-sm font-medium text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                        Save Feedback
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Meal completion functionality
function toggleMealCompletion(mealId, date) {
    // Check if this is the current day (only allow editing current day)
    const today = new Date().toISOString().split('T')[0];
    if (date !== today) {
        alert('You can only mark meals as completed for today.');
        return;
    }
    
    const button = document.querySelector(`[data-meal-id="${mealId}"][data-date="${date}"]`);
    const mealCard = document.querySelector(`.meal-card[data-meal-id="${mealId}"][data-date="${date}"]`);
    
    // Check if meal is currently completed
    const isCompleted = mealCard.classList.contains('bg-green-50');
    
    if (isCompleted) {
        // Unmark as completed
        fetch(`/meals/meals/${mealId}/uncomplete/`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify({ date: date })
        })
        .then(response => response.json())
        .then(data => {
            if (data.meal_id) {
                // Update UI to show as scheduled
                mealCard.classList.remove('bg-green-50', 'border-green-200');
                mealCard.classList.add('bg-blue-50', 'border-blue-200');
                
                // Update all text colors
                const mealName = mealCard.querySelector('.text-sm');
                const mealTime = mealCard.querySelector('.text-xs');
                const mealType = mealCard.querySelector('.text-xs:last-child');
                const recurrenceSpan = mealType.querySelector('span');
                
                mealName.classList.remove('text-green-900');
                mealName.classList.add('text-blue-900');
                mealTime.classList.remove('text-green-700');
                mealTime.classList.add('text-blue-700');
                mealType.classList.remove('text-green-600');
                mealType.classList.add('text-blue-600');
                if (recurrenceSpan) {
                    recurrenceSpan.classList.remove('text-green-500');
                    recurrenceSpan.classList.add('text-blue-500');
                }
                
                // Update button
                button.classList.remove('bg-green-200', 'hover:bg-green-300');
                const iconSpan = button.querySelector('.material-icons');
                iconSpan.classList.remove('text-green-600');
                iconSpan.classList.add('text-gray-400');
                iconSpan.textContent = 'radio_button_unchecked';
                button.title = 'Mark as completed';
                
                location.reload(); // Reload to update nutrition totals
            } else {
                alert('Error unmarking meal as completed: ' + JSON.stringify(data));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error unmarking meal as completed');
        });
    } else {
        // Mark as completed
        fetch(`/meals/meals/${mealId}/complete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify({ 
                date: date 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.meal_id) {
                // Update UI to show as completed
                mealCard.classList.remove('bg-blue-50', 'border-blue-200');
                mealCard.classList.add('bg-green-50', 'border-green-200');
                
                // Update all text colors
                const mealName = mealCard.querySelector('.text-sm');
                const mealTime = mealCard.querySelector('.text-xs');
                const mealType = mealCard.querySelector('.text-xs:last-child');
                const recurrenceSpan = mealType.querySelector('span');
                
                mealName.classList.remove('text-blue-900');
                mealName.classList.add('text-green-900');
                mealTime.classList.remove('text-blue-700');
                mealTime.classList.add('text-green-700');
                mealType.classList.remove('text-blue-600');
                mealType.classList.add('text-green-600');
                if (recurrenceSpan) {
                    recurrenceSpan.classList.remove('text-blue-500');
                    recurrenceSpan.classList.add('text-green-500');
                }
                
                // Update button
                button.classList.add('bg-green-200', 'hover:bg-green-300');
                const iconSpan = button.querySelector('.material-icons');
                iconSpan.classList.remove('text-gray-400');
                iconSpan.classList.add('text-green-600');
                iconSpan.textContent = 'check_circle';
                button.title = 'Unmark as completed';
                
                location.reload(); // Reload to update nutrition totals
            } else {
                alert('Error marking meal as completed: ' + JSON.stringify(data));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error marking meal as completed');
        });
    }
}

// Log Meal Functions (Record Only)
function openLogMealModal(date) {
    document.getElementById('log_date').value = date;
    
    // Pre-fill current time if it's today
    const today = new Date().toISOString().split('T')[0];
    if (date === today) {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        document.getElementById('log_time').value = `${hours}:${minutes}`;
    }
    
    document.getElementById('logMealModal').classList.remove('hidden');
}

function closeLogMealModal() {
    document.getElementById('logMealModal').classList.add('hidden');
    document.getElementById('logMealForm').reset();
}

// Handle log meal form submission
document.getElementById('logMealForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/meals/meals/log-meal/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeLogMealModal();
            location.reload(); // Reload to show the new meal record
        } else {
            alert('Error logging meal: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error logging meal');
    });
});

// Edit and Delete Meal Record Functions
function openEditMealRecordModal(recordId) {
    // For now, just reload the page - we can implement edit modal later
    // This would open a modal similar to log meal but pre-filled with record data
    alert('Edit functionality coming soon!');
}

function deleteMealRecord(recordId) {
    if (confirm('Are you sure you want to delete this meal record?')) {
        fetch(`/meals/meals/record/${recordId}/delete/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload to update the display
            } else {
                alert('Error deleting meal record: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error deleting meal record');
        });
    }
}

// Meal Scheduling Functions
function openAddMealModal(date) {
    document.getElementById('schedule_date').value = date;
    document.getElementById('scheduleMealModal').classList.remove('hidden');
}

function closeScheduleMealModal() {
    document.getElementById('scheduleMealModal').classList.add('hidden');
    document.getElementById('scheduleMealForm').reset();
}

function removeSchedule() {
    // This function would handle removing a meal schedule
    // For now, just close the modal
    closeScheduleMealModal();
}

// Handle recurrence type changes
document.getElementById('schedule_recurrence').addEventListener('change', function() {
    const recurrenceType = this.value;
    const endDateDiv = document.getElementById('end_date_div');
    const recurrenceUntilDiv = document.getElementById('recurrence_until_div');
    
    if (recurrenceType === 'none') {
        endDateDiv.classList.add('hidden');
        recurrenceUntilDiv.classList.add('hidden');
    } else {
        endDateDiv.classList.remove('hidden');
        if (recurrenceType === 'custom') {
            recurrenceUntilDiv.classList.remove('hidden');
        } else {
            recurrenceUntilDiv.classList.add('hidden');
        }
    }
});

// Handle meal scheduling form submission
document.getElementById('scheduleMealForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch('/meals/meals/create-and-schedule/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeScheduleMealModal();
            location.reload(); // Reload to show the new meal
        } else {
            alert('Error scheduling meal: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error scheduling meal');
    });
});

// Get CSRF token
function getCookie(name) {
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken && name === 'csrftoken') {
        return metaToken.getAttribute('content');
    }
    
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Feedback Modal Functions
function openFeedbackModal(mealId, date) {
    document.getElementById('feedbackMealId').value = mealId;
    document.getElementById('feedbackDate').value = date;
    
    // Load existing feedback if available
    loadExistingFeedback(mealId, date);
    
    document.getElementById('feedbackModal').classList.remove('hidden');
}

function closeFeedbackModal() {
    document.getElementById('feedbackModal').classList.add('hidden');
    document.getElementById('feedbackForm').reset();
}

function loadExistingFeedback(mealId, date) {
    fetch(`/meals/meals/${mealId}/feedback/?date=${date}`, {
        method: 'GET',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.feedback) {
            document.getElementById('feedbackText').value = data.feedback;
        }
        if (data.photo_url) {
            // Show existing photo if available
            const photoContainer = document.createElement('div');
            photoContainer.className = 'mb-2';
            photoContainer.innerHTML = `
                <img src="${data.photo_url}" alt="Meal photo" class="w-20 h-20 object-cover rounded">
                <p class="text-xs text-gray-500 mt-1">Current photo</p>
            `;
            document.getElementById('feedbackPhoto').parentNode.appendChild(photoContainer);
        }
    })
    .catch(error => {
        console.error('Error loading feedback:', error);
    });
}

// Check for existing feedback and update icons
function checkExistingFeedback() {
    const feedbackIcons = document.querySelectorAll('.feedback-icon');
    feedbackIcons.forEach(icon => {
        const mealId = icon.getAttribute('data-meal-id');
        const date = icon.getAttribute('data-date');
        
        fetch(`/meals/meals/${mealId}/feedback/?date=${date}`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.feedback || data.photo_url) {
                // Update icon to show feedback exists
                icon.textContent = 'rate_review';
                icon.classList.remove('text-blue-600');
                icon.classList.add('text-green-600');
                icon.parentElement.title = 'Edit feedback';
            }
        })
        .catch(error => {
            console.error('Error checking feedback:', error);
        });
    });
}

// Check for existing feedback when page loads
document.addEventListener('DOMContentLoaded', function() {
    checkExistingFeedback();
});

// Handle feedback form submission
document.getElementById('feedbackForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData();
    formData.append('meal_id', document.getElementById('feedbackMealId').value);
    formData.append('date', document.getElementById('feedbackDate').value);
    formData.append('feedback', document.getElementById('feedbackText').value);
    
    const photoFile = document.getElementById('feedbackPhoto').files[0];
    if (photoFile) {
        formData.append('photo', photoFile);
    }
    
    const mealId = document.getElementById('feedbackMealId').value;
    fetch(`/meals/meals/${mealId}/feedback/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeFeedbackModal();
            // Optionally reload the page to show updated feedback
            location.reload();
        } else {
            alert('Error saving feedback: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving feedback');
    });
});
</script>
{% endblock %}
