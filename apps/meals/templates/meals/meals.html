{% extends "base.html" %}
{% load meal_extras %}

{% block title %}Meals Management{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Meals Management</h1>
                <p class="text-gray-600">Create and manage your meals with ingredients</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="openMealModal()" 
                        class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                    Add Meal
                </button>
                <a href="{% url 'meals:calendar' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    Calendar View
                </a>
                <a href="{% url 'meals:dashboard' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                    Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <!-- Diet Filter -->
    <div class="bg-white rounded-lg shadow mb-8">
        <div class="p-6">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-medium text-gray-900">Filter by Diet</h2>
                    <p class="text-sm text-gray-600">Select a diet to filter meals</p>
                </div>
                <div class="flex items-center space-x-3">
                    <select id="dietFilter" onchange="filterByDiet()" 
                            class="border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="">All Diets</option>
                        {% for diet in diets %}
                        <option value="{{ diet.id }}" {% if selected_diet_id == diet.id %}selected{% endif %}>
                            {{ diet.name }}{% if diet.is_active %} (Active){% endif %}
                        </option>
                        {% endfor %}
                    </select>
                    <button onclick="clearDietFilter()" 
                            class="px-3 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        Clear Filter
                    </button>
                </div>
            </div>
            
            <!-- Active Diet Indicator -->
            {% for diet in diets %}
                {% if diet.is_active %}
                <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded-md">
                    <div class="flex items-center">
                        <div class="flex-shrink-0">
                            <svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                            </svg>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm font-medium text-green-800">
                                Active Diet: {{ diet.name }}
                            </p>
                            <p class="text-sm text-green-700">
                                Goal: {{ diet.goal.get_goal_type_display }}
                            </p>
                        </div>
                        <div class="ml-auto">
                            <button onclick="setActiveDiet({{ diet.id }})" 
                                    class="text-sm text-green-600 hover:text-green-500 font-medium">
                                Change Active Diet
                            </button>
                        </div>
                    </div>
                </div>
                {% endif %}
            {% endfor %}
        </div>
    </div>

    <!-- Meals Summary -->
    <div class="mb-4">
        <p class="text-sm text-gray-600">
            {% if selected_diet_id %}
                Showing {{ meals.count }} meal{{ meals.count|pluralize }} for 
                {% for diet in diets %}
                    {% if diet.id == selected_diet_id %}{{ diet.name }}{% endif %}
                {% endfor %}
            {% else %}
                Showing {{ meals.count }} meal{{ meals.count|pluralize }} across all diets
            {% endif %}
        </p>
    </div>

    <!-- Meals Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {% for meal in meals %}
        <div class="bg-white rounded-lg shadow hover:shadow-lg transition-shadow duration-200 {% if meal.is_scheduled %}border-l-4 border-green-500{% endif %}" 
             data-meal-id="{{ meal.id }}"
             {% if meal.is_scheduled %}
             data-schedule-date="{{ meal.start_date|date:'Y-m-d' }}"
             data-schedule-end-date="{{ meal.end_date|date:'Y-m-d'|default:'' }}"
             data-schedule-time="{{ meal.start_time|time:'H:i' }}"
             data-schedule-duration="{{ meal.duration_minutes }}"
             data-schedule-type="{{ meal.meal_type }}"
             data-schedule-recurrence="{{ meal.recurrence_type }}"
             data-schedule-until="{{ meal.recurrence_until|date:'Y-m-d'|default:'' }}"
             {% endif %}>
            <div class="p-6">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 mb-1">
                            <h3 class="text-xl font-semibold text-gray-900">{{ meal.name }}</h3>
                            {% if meal.is_scheduled %}
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                </svg>
                                {% if meal.recurrence_type != 'none' %}
                                    <br><span class="text-green-600 text-xs">{{ meal.recurrence_type|format_recurrence }}&nbsp;</span>
                                {% endif %}
                                {% if meal.start_date %}
                                    {% if meal.start_time %}
                                        {% if meal.recurrence_type == 'none' %}
                                            {{ meal.start_date|date:"M j" }} 
                                        {% endif %}    
                                        at {{ meal.start_time|time:"g:i A" }}
                                    {% else %}
                                        {{ meal.start_date|date:"M j" }}
                                    {% endif %}
                                {% else %}
                                    Scheduled
                                {% endif %}
                            </span>
                            {% endif %}
                        </div>
                        <div class="flex items-center mt-1">
                            <p class="text-sm text-gray-600">{{ meal.diet.name }}</p>
                            {% if meal.diet.is_active %}
                            <span class="ml-2 inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">
                                Active
                            </span>
                            {% endif %}
                        </div>
                        {% if meal.description %}
                        <p class="text-sm text-gray-600 mt-1">{{ meal.description|truncatewords:20 }}</p>
                        {% endif %}
                    </div>
                    <div class="flex space-x-2 ml-4">
                        <button onclick="scheduleMeal({{ meal.id }})" 
                                class="{% if meal.is_scheduled %}text-green-400 hover:text-green-600{% else %}text-gray-400 hover:text-blue-600{% endif %} transition-colors duration-200"
                                title="{% if meal.is_scheduled %}Edit schedule{% else %}Schedule meal{% endif %}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </button>
                        <button onclick="editMeal({{ meal.id }})" 
                                class="text-gray-400 hover:text-blue-600 transition-colors duration-200"
                                title="Edit meal">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                        </button>
                        <button onclick="deleteMeal({{ meal.id }}, '{{ meal.name }}')" 
                                class="text-gray-400 hover:text-red-600 transition-colors duration-200"
                                title="Delete meal">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Ingredients List -->
                <div class="mb-4">
                    <div class="flex items-center justify-between mb-2">
                        <h4 class="text-sm font-medium text-gray-700">Ingredients</h4>
                        <button onclick="openAddIngredientModal({{ meal.id }})" 
                                class="text-sm text-blue-600 hover:text-blue-700 font-medium">
                            + Add Ingredient
                        </button>
                    </div>
                    
                    {% if meal.mealingredient_set.all %}
                    <div class="space-y-2">
                        {% for meal_ingredient in meal.mealingredient_set.all %}
                        <div class="flex items-center justify-between p-2 bg-gray-50 rounded">
                            <div class="flex-1">
                                <span class="text-sm font-medium text-gray-900">{{ meal_ingredient.ingredient.name }}</span>
                                <span class="text-sm text-gray-600 ml-2">{{ meal_ingredient.quantity }}g</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="editIngredientQuantity({{ meal_ingredient.id }}, {{ meal_ingredient.quantity }})" 
                                        class="text-gray-400 hover:text-blue-600 transition-colors duration-200"
                                        title="Edit quantity">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>
                                <button onclick="removeIngredient({{ meal_ingredient.id }}, '{{ meal_ingredient.ingredient.name }}')" 
                                        class="text-gray-400 hover:text-red-600 transition-colors duration-200"
                                        title="Remove ingredient">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <p class="text-sm text-gray-500 italic">No ingredients added yet</p>
                    {% endif %}
                </div>

                <!-- Nutritional Summary -->
                {% if meal.mealingredient_set.all %}
                <div class="border-t pt-4">
                    <h4 class="text-sm font-medium text-gray-700 mb-2">Nutritional Summary</h4>
                    <div class="grid grid-cols-4 gap-2 text-center">
                        <div class="p-2 bg-blue-50 rounded">
                            <div class="text-sm font-bold text-blue-900">{{ meal|calculate_total_calories|floatformat:0 }}</div>
                            <div class="text-xs text-blue-600">Calories</div>
                        </div>
                        <div class="p-2 bg-green-50 rounded">
                            <div class="text-sm font-bold text-green-900">{{ meal|calculate_total_proteins|floatformat:1 }}g</div>
                            <div class="text-xs text-green-600">Protein</div>
                        </div>
                        <div class="p-2 bg-yellow-50 rounded">
                            <div class="text-sm font-bold text-yellow-900">{{ meal|calculate_total_carbs|floatformat:1 }}g</div>
                            <div class="text-xs text-yellow-600">Carbs</div>
                        </div>
                        <div class="p-2 bg-red-50 rounded">
                            <div class="text-sm font-bold text-red-900">{{ meal|calculate_total_fats|floatformat:1 }}g</div>
                            <div class="text-xs text-red-600">Fat</div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% empty %}
        <div class="col-span-full">
            <div class="bg-white rounded-lg shadow p-12 text-center">
                <div class="mx-auto w-24 h-24 text-gray-400">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.746 0 3.332.477 4.5 1.253v13C19.832 18.477 18.246 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path>
                    </svg>
                </div>
                <h3 class="mt-4 text-lg font-medium text-gray-900">No meals yet</h3>
                <p class="mt-2 text-gray-600">Create your first meal to get started.</p>
                <div class="mt-6">
                    <button onclick="openMealModal()" 
                            class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                        Create Your First Meal
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Meal Modal -->
<div id="mealModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900" id="mealModalTitle">Add Meal</h3>
                    <button onclick="closeMealModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <form id="mealForm" class="p-6">
                <input type="hidden" id="meal_id" name="meal_id">
                <div class="space-y-4">
                    <div>
                        <label for="meal_name" class="block text-sm font-medium text-gray-700">Name *</label>
                        <input type="text" id="meal_name" name="name" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="meal_diet" class="block text-sm font-medium text-gray-700">Diet *</label>
                        <select id="meal_diet" name="diet_id" required
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select a diet</option>
                            {% for diet in diets %}
                            <option value="{{ diet.id }}">{{ diet.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="meal_description" class="block text-sm font-medium text-gray-700">Description</label>
                        <textarea id="meal_description" name="description" rows="3"
                                  class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                  placeholder="Optional description of the meal..."></textarea>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeMealModal()" 
                            class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                        <span id="mealSubmitButtonText">Add Meal</span>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Add Ingredient Modal -->
<div id="addIngredientModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">Add Ingredient</h3>
                    <button onclick="closeAddIngredientModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <form id="addIngredientForm" class="p-6">
                <input type="hidden" id="target_meal_id" name="meal_id">
                <div class="space-y-4">
                    <div>
                        <label for="ingredient_select" class="block text-sm font-medium text-gray-700">Ingredient *</label>
                        <select id="ingredient_select" name="ingredient_id" required
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Select an ingredient</option>
                            {% for ingredient in ingredients %}
                            <option value="{{ ingredient.id }}">{{ ingredient.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div>
                        <label for="ingredient_quantity" class="block text-sm font-medium text-gray-700">Quantity (grams) *</label>
                        <input type="number" id="ingredient_quantity" name="quantity" step="0.1" min="0" value="100" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeAddIngredientModal()" 
                            class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                        Add Ingredient
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Quantity Modal -->
<div id="editQuantityModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-sm w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">Edit Quantity</h3>
            </div>
            <form id="editQuantityForm" class="p-6">
                <input type="hidden" id="edit_meal_ingredient_id" name="meal_ingredient_id">
                <div class="space-y-4">
                    <div>
                        <label for="edit_quantity" class="block text-sm font-medium text-gray-700">Quantity (grams) *</label>
                        <input type="number" id="edit_quantity" name="quantity" step="0.1" min="0" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end space-x-3">
                    <button type="button" onclick="closeEditQuantityModal()" 
                            class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                        Cancel
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                        Update
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Schedule Meal Modal -->
<div id="scheduleMealModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h3 class="text-lg font-medium text-gray-900">Schedule Meal</h3>
                    <button onclick="closeScheduleMealModal()" class="text-gray-400 hover:text-gray-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                </div>
            </div>
            <form id="scheduleMealForm" class="p-6">
                <input type="hidden" id="schedule_meal_id" name="meal_id">
                <div class="space-y-4">
                    <div>
                        <label for="schedule_date" class="block text-sm font-medium text-gray-700">Start Date *</label>
                        <input type="date" id="schedule_date" name="start_date" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div id="end_date_div" class="hidden">
                        <label for="schedule_end_date" class="block text-sm font-medium text-gray-700">End Date</label>
                        <input type="date" id="schedule_end_date" name="end_date"
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                        <p class="text-xs text-gray-500 mt-1">Leave empty for no end date</p>
                    </div>
                    
                    <div>
                        <label for="schedule_time" class="block text-sm font-medium text-gray-700">Time *</label>
                        <input type="time" id="schedule_time" name="start_time" required
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="schedule_duration" class="block text-sm font-medium text-gray-700">Duration (minutes)</label>
                        <input type="number" id="schedule_duration" name="duration_minutes" value="30" min="15" max="180" step="15"
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    
                    <div>
                        <label for="schedule_meal_type" class="block text-sm font-medium text-gray-700">Meal Type</label>
                        <select id="schedule_meal_type" name="meal_type"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="regular">Regular Meal</option>
                            <option value="cheat">Cheat Meal</option>
                            <option value="refeed">Refeed Meal</option>
                            <option value="pre_workout">Pre-Workout</option>
                            <option value="post_workout">Post-Workout</option>
                            <option value="snack">Snack</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="schedule_recurrence" class="block text-sm font-medium text-gray-700">Recurrence</label>
                        <select id="schedule_recurrence" name="recurrence_type"
                                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="none">No Recurrence</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="weekday">Weekdays (Mon-Fri)</option>
                            <option value="weekend">Weekends (Sat-Sun)</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    
                    <div id="recurrence_until_div" class="hidden">
                        <label for="schedule_recurrence_until" class="block text-sm font-medium text-gray-700">Until Date</label>
                        <input type="date" id="schedule_recurrence_until" name="recurrence_until"
                               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>
                
                <div class="mt-6 flex justify-between">
                    <button type="button" onclick="removeSchedule()" 
                            class="px-4 py-2 border border-red-300 text-sm font-medium rounded-md text-red-700 bg-white hover:bg-red-50"
                            id="removeScheduleBtn" style="display: none;">
                        Remove Schedule
                    </button>
                    <div class="flex space-x-3">
                        <button type="button" onclick="closeScheduleMealModal()" 
                                class="px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
                            Cancel
                        </button>
                        <button type="submit" 
                                class="px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700">
                            <span id="scheduleSubmitText">Schedule Meal</span>
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// Meal management functions
function openMealModal() {
    document.getElementById('mealModalTitle').textContent = 'Add Meal';
    document.getElementById('mealSubmitButtonText').textContent = 'Add Meal';
    document.getElementById('mealForm').reset();
    document.getElementById('meal_id').value = '';
    document.getElementById('mealModal').classList.remove('hidden');
}

function closeMealModal() {
    document.getElementById('mealModal').classList.add('hidden');
    document.getElementById('mealForm').reset();
}

function editMeal(mealId) {
    fetch(`/meals/meals/${mealId}/get/`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            document.getElementById('mealModalTitle').textContent = 'Edit Meal';
            document.getElementById('mealSubmitButtonText').textContent = 'Update Meal';
            document.getElementById('meal_id').value = data.id;
            document.getElementById('meal_name').value = data.name;
            document.getElementById('meal_diet').value = data.diet_id;
            document.getElementById('meal_description').value = data.description || '';
            
            document.getElementById('mealModal').classList.remove('hidden');
        } else {
            alert('Error loading meal data');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error loading meal data');
    });
}

function deleteMeal(mealId, mealName) {
    if (!confirm(`Are you sure you want to delete "${mealName}"?`)) {
        return;
    }
    
    fetch(`/meals/meals/${mealId}/delete/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            location.reload();
        } else {
            alert('Error deleting meal');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting meal');
    });
}

// Meal form submission
document.getElementById('mealForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const mealId = formData.get('meal_id');
    const data = {
        name: formData.get('name'),
        diet_id: formData.get('diet_id'),
        description: formData.get('description') || ''
    };
    
    const url = mealId ? `/meals/meals/${mealId}/update/` : '/meals/meals/create/';
    const method = mealId ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin',
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            closeMealModal();
            location.reload();
        } else {
            alert('Error saving meal: ' + JSON.stringify(data));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error saving meal');
    });
});

// Ingredient management functions
function openAddIngredientModal(mealId) {
    document.getElementById('target_meal_id').value = mealId;
    document.getElementById('addIngredientForm').reset();
    document.getElementById('ingredient_quantity').value = '100';
    document.getElementById('addIngredientModal').classList.remove('hidden');
}

function closeAddIngredientModal() {
    document.getElementById('addIngredientModal').classList.add('hidden');
    document.getElementById('addIngredientForm').reset();
}

function editIngredientQuantity(mealIngredientId, currentQuantity) {
    document.getElementById('edit_meal_ingredient_id').value = mealIngredientId;
    document.getElementById('edit_quantity').value = currentQuantity;
    document.getElementById('editQuantityModal').classList.remove('hidden');
}

function closeEditQuantityModal() {
    document.getElementById('editQuantityModal').classList.add('hidden');
    document.getElementById('editQuantityForm').reset();
}

function removeIngredient(mealIngredientId, ingredientName) {
    if (!confirm(`Are you sure you want to remove "${ingredientName}" from this meal?`)) {
        return;
    }
    
    fetch(`/meals/meal-ingredients/${mealIngredientId}/remove/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.message) {
            location.reload();
        } else {
            alert('Error removing ingredient');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error removing ingredient');
    });
}

// Add ingredient form submission
document.getElementById('addIngredientForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const mealId = formData.get('meal_id');
    const data = {
        ingredient_id: formData.get('ingredient_id'),
        quantity: parseFloat(formData.get('quantity'))
    };
    
    fetch(`/meals/meals/${mealId}/add-ingredient/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin',
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            closeAddIngredientModal();
            location.reload();
        } else {
            alert('Error adding ingredient: ' + JSON.stringify(data));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error adding ingredient');
    });
});

// Edit quantity form submission
document.getElementById('editQuantityForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const mealIngredientId = formData.get('meal_ingredient_id');
    const data = {
        quantity: parseFloat(formData.get('quantity'))
    };
    
    fetch(`/meals/meal-ingredients/${mealIngredientId}/update/`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin',
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            closeEditQuantityModal();
            location.reload();
        } else {
            alert('Error updating quantity: ' + JSON.stringify(data));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error updating quantity');
    });
});

// Diet filtering functions
function filterByDiet() {
    const dietSelect = document.getElementById('dietFilter');
    const selectedDietId = dietSelect.value;
    
    // Build the URL with the selected diet
    let url = window.location.pathname;
    if (selectedDietId) {
        url += '?diet=' + selectedDietId;
    }
    
    window.location.href = url;
}

function clearDietFilter() {
    window.location.href = window.location.pathname;
}

function setActiveDiet(dietId) {
    if (!confirm('Are you sure you want to change the active diet? This will deactivate the current active diet.')) {
        return;
    }
    
    fetch(`/meals/diets/${dietId}/set-active/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            location.reload();
        } else {
            alert('Error setting active diet: ' + JSON.stringify(data));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error setting active diet');
    });
}

function scheduleMeal(mealId) {
    // Open scheduling modal
    document.getElementById('schedule_meal_id').value = mealId;
    
    // Check if meal is already scheduled
    const mealCard = document.querySelector(`[data-meal-id="${mealId}"]`);
    const isScheduled = mealCard && mealCard.classList.contains('border-green-500');
    
    if (isScheduled) {
        // Load existing schedule data
        loadExistingSchedule(mealId);
        document.getElementById('scheduleSubmitText').textContent = 'Update Schedule';
        document.getElementById('removeScheduleBtn').style.display = 'block';
    } else {
        // Set default values for new schedule
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('schedule_date').value = today;
        document.getElementById('schedule_time').value = '12:00';
        document.getElementById('schedule_duration').value = '30';
        document.getElementById('schedule_meal_type').value = 'regular';
        document.getElementById('schedule_recurrence').value = 'none';
        document.getElementById('scheduleSubmitText').textContent = 'Schedule Meal';
        document.getElementById('removeScheduleBtn').style.display = 'none';
    }
    
    // Show the modal
    document.getElementById('scheduleMealModal').classList.remove('hidden');
}

function loadExistingSchedule(mealId) {
    // Get the meal card element
    const mealCard = document.querySelector(`[data-meal-id="${mealId}"]`);
    if (!mealCard) return;
    
    // Load scheduling data from data attributes
    const scheduleDate = mealCard.dataset.scheduleDate;
    const scheduleEndDate = mealCard.dataset.scheduleEndDate;
    const scheduleTime = mealCard.dataset.scheduleTime;
    const scheduleDuration = mealCard.dataset.scheduleDuration;
    const scheduleType = mealCard.dataset.scheduleType;
    const scheduleRecurrence = mealCard.dataset.scheduleRecurrence;
    const scheduleUntil = mealCard.dataset.scheduleUntil;
    
    // Populate the form fields
    if (scheduleDate) {
        document.getElementById('schedule_date').value = scheduleDate;
    }
    
    if (scheduleEndDate) {
        document.getElementById('schedule_end_date').value = scheduleEndDate;
    }
    
    if (scheduleTime) {
        document.getElementById('schedule_time').value = scheduleTime;
    }
    
    if (scheduleDuration) {
        document.getElementById('schedule_duration').value = scheduleDuration;
    }
    
    if (scheduleType) {
        document.getElementById('schedule_meal_type').value = scheduleType;
    }
    
    if (scheduleRecurrence) {
        document.getElementById('schedule_recurrence').value = scheduleRecurrence;
        // Show the end date and recurrence until fields if it's not 'none'
        if (scheduleRecurrence !== 'none') {
            document.getElementById('end_date_div').classList.remove('hidden');
            document.getElementById('recurrence_until_div').classList.remove('hidden');
        }
    }
    
    if (scheduleUntil) {
        document.getElementById('schedule_recurrence_until').value = scheduleUntil;
    }
}

function removeSchedule() {
    const mealId = document.getElementById('schedule_meal_id').value;
    
    if (!confirm('Are you sure you want to remove this schedule? This will delete the meal from your calendar.')) {
        return;
    }
    
    fetch(`/meals/meals/${mealId}/unschedule/`, {
        method: 'DELETE',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.id) {
            closeScheduleMealModal();
            location.reload();
        } else {
            alert('Error removing schedule: ' + JSON.stringify(data));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error removing schedule');
    });
}

function closeScheduleMealModal() {
    document.getElementById('scheduleMealModal').classList.add('hidden');
    document.getElementById('scheduleMealForm').reset();
}

function openScheduleMealModal() {
    document.getElementById('scheduleMealModal').classList.remove('hidden');
}



// Schedule meal form submission
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('scheduleMealForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const mealId = formData.get('meal_id');
        
        const data = {
            is_scheduled: true,
            start_date: formData.get('start_date'),
            start_time: formData.get('start_time') + ':00', // Add seconds
            duration_minutes: parseInt(formData.get('duration_minutes')),
            recurrence_type: formData.get('recurrence_type'),
            meal_type: formData.get('meal_type')
        };
        
        // Add end date if provided
        const endDate = formData.get('end_date');
        if (endDate && data.recurrence_type !== 'none') {
            data.end_date = endDate;
        }
        
        // Add recurrence until date if provided (for backward compatibility)
        const recurrenceUntil = formData.get('recurrence_until');
        if (recurrenceUntil && data.recurrence_type !== 'none') {
            data.recurrence_until = recurrenceUntil;
        }
        
        fetch(`/meals/meals/${mealId}/schedule/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.id) {
                closeScheduleMealModal();
                location.reload();
            } else {
                alert('Error scheduling meal: ' + JSON.stringify(data));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error scheduling meal');
        });
    });

    // Show/hide end date and recurrence until fields based on recurrence type
    document.getElementById('schedule_recurrence').addEventListener('change', function() {
        const endDateDiv = document.getElementById('end_date_div');
        const recurrenceUntilDiv = document.getElementById('recurrence_until_div');
        
        if (this.value !== 'none') {
            endDateDiv.classList.remove('hidden');
            recurrenceUntilDiv.classList.remove('hidden');
        } else {
            endDateDiv.classList.add('hidden');
            recurrenceUntilDiv.classList.add('hidden');
        }
    });
});

// Get CSRF token
function getCookie(name) {
    const metaToken = document.querySelector('meta[name="csrf-token"]');
    if (metaToken && name === 'csrftoken') {
        return metaToken.getAttribute('content');
    }
    
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
{% endblock %}
